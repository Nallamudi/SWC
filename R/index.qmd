---
title: "Weekly Market Update"
author: "Sarath Nallamudi"
format: hugo
editor: visual
date: '`r format(Sys.Date(), "%Y-%m-%d")`'
freeze: true
categories: ["Markets"]
tags: ["SPY", "DOW", "NASDAQ","SPX", "VIX"]
toc: true
---

## Equity markets

```{r}
#| echo: false
#| warning: false
#| message: false
#| error: false

library(tidyverse)
library(lubridate)
library(Technical)
library(IBrokers)

library(TTR)
library(quantmod)
library(PerformanceAnalytics)
library(PortfolioAnalytics)
library(gt)
library(gganimate)
library(DT)
library(bslib)
library(flextable)

options(scipen = 99999)
Fred_Func()

```

Equity markets were still consolidating last week above the 200 day moving averages. CPI day last week couldn't provide any resolution to the markets on either side.

```{r Get_Data}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true

#### SP500
SPX_Daily <- getSymbols.yahoo("^GSPC", from='2000-01-01', periodicity = 'daily', auto.assign=FALSE)
SPX_Daily <- data.frame(Date = index(SPX_Daily), coredata(SPX_Daily))
colnames(SPX_Daily) <- c("PDate", "Open","High","Low","Close","Volume","Adj")

SPX_Daily<- add_dates(SPX_Daily, "PDate")
SPX_Daily$Return <- TTR::ROC(SPX_Daily$Close)

#SPX_Daily <- Daily_Metrics(SPX_Daily, "PDate")

SPX_Weekly <- SPX_Daily%>%
  group_by(Price_Week)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Weekly_return = ROC(Close)
  )

SPX_Yearly <- SPX_Daily%>%
  group_by(Price_Year)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Yearly_return = ROC(Close)
  )

SPX_Monthly <- SPX_Daily%>%
  group_by(Price_Month)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj),
    Month = unique(format(PDate, "%B"))
    )%>%
  mutate(
    Monthly_return = ROC(Close)
  )


#### Nasdaq
NDX_Daily <- getSymbols.yahoo("^IXIC", from='2000-01-01', periodicity = 'daily', auto.assign=FALSE)
NDX_Daily <- data.frame(Date = index(NDX_Daily), coredata(NDX_Daily))
colnames(NDX_Daily) <- c("PDate", "Open","High","Low","Close","Volume","Adj")

NDX_Daily<- add_dates(NDX_Daily, "PDate")
NDX_Daily$Return <- TTR::ROC(NDX_Daily$Close)

NDX_Weekly <- NDX_Daily%>%
  group_by(Price_Week)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Weekly_return = ROC(Close)
  )

NDX_Yearly <- NDX_Daily%>%
  group_by(Price_Year)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Yearly_return = ROC(Close)
  )

NDX_Monthly <- NDX_Daily%>%
  group_by(Price_Month)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj),
    Month = unique(format(PDate, "%B"))
    )%>%
  mutate(
    Monthly_return = ROC(Close)
  )

#### Dow Jones

DJI_Daily <- getSymbols.yahoo("^DJI", from='2000-01-01', periodicity = 'daily', auto.assign=FALSE)
DJI_Daily <- data.frame(Date = index(DJI_Daily), coredata(DJI_Daily))
colnames(DJI_Daily) <- c("PDate", "Open","High","Low","Close","Volume","Adj")

DJI_Daily<- add_dates(DJI_Daily, "PDate")
DJI_Daily$Return <- TTR::ROC(DJI_Daily$Close)

DJI_Weekly <- DJI_Daily%>%
  group_by(Price_Week)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Weekly_return = ROC(Close)
  )

DJI_Yearly <- DJI_Daily%>%
  group_by(Price_Year)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Yearly_return = ROC(Close)
  )

DJI_Monthly <- DJI_Daily%>%
  group_by(Price_Month)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj),
    Month = unique(format(PDate, "%B"))
    )%>%
  mutate(
    Monthly_return = ROC(Close)
  )

#### Russell

RUT_Daily <- getSymbols.yahoo("^RUT", from='2000-01-01', periodicity = 'daily', auto.assign=FALSE)
RUT_Daily <- data.frame(Date = index(RUT_Daily), coredata(RUT_Daily))
colnames(RUT_Daily) <- c("PDate", "Open","High","Low","Close","Volume","Adj")

RUT_Daily<- add_dates(RUT_Daily, "PDate")
RUT_Daily$Return <- TTR::ROC(RUT_Daily$Close)

RUT_Weekly <- RUT_Daily%>%
  group_by(Price_Week)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Weekly_return = ROC(Close)
  )

RUT_Yearly <- RUT_Daily%>%
  group_by(Price_Year)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Yearly_return = ROC(Close)
  )

RUT_Monthly <- RUT_Daily%>%
  group_by(Price_Month)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj),
    Month = unique(format(PDate, "%B"))
    )%>%
  mutate(
    Monthly_return = ROC(Close)
  )

#### VIX

VIX_Daily <- getSymbols.yahoo("^VIX", from='2000-01-01', periodicity = 'daily', auto.assign=FALSE)
VIX_Daily <- data.frame(Date = index(VIX_Daily), coredata(VIX_Daily))
colnames(VIX_Daily) <- c("PDate", "Open","High","Low","Close","Volume","Adj")

VIX_Daily<- add_dates(VIX_Daily, "PDate")
VIX_Daily$Return <- TTR::ROC(VIX_Daily$Close)

VIX_Weekly <- VIX_Daily%>%
  group_by(Price_Week)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Weekly_return = ROC(Close)
  )

VIX_Yearly <- VIX_Daily%>%
  group_by(Price_Year)%>%
  summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj)
    )%>%
  mutate(
    Yearly_return = ROC(Close)
  )

VIX_Monthly <- VIX_Daily%>%
  group_by(Price_Month)%>%
   summarise(
    Open = first(Open),
    High = max(Adj),
    Low = min(Adj),
    Close = last(Adj),
    Month = unique(format(PDate, "%B"))
    )%>%
  mutate(
    Monthly_return = ROC(Close)
  )

```

```{r Weekly Return}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true
#| results: asis
#| tbl-cap: "Stock market this week" 

Weekly <- data.frame(Index = "S&P 500", SPX_Weekly[nrow(SPX_Weekly),])
Weekly <- rbind(Weekly, c(Index="Nasdaq", NDX_Weekly[nrow(NDX_Weekly),]))
Weekly <- rbind(Weekly, c(Index="Dow Jones", DJI_Weekly[nrow(DJI_Weekly),]))
Weekly <- rbind(Weekly, c(Index="Russell", RUT_Weekly[nrow(RUT_Weekly),]))
Weekly <- rbind(Weekly, c(Index="VIX", VIX_Weekly[nrow(VIX_Weekly),]))

# Weekly%>%
#   gt()%>%
#   fmt_percent(columns = "Weekly_return")%>%
#   cols_label(Index="Index",Price_Week = "Week", Weekly_return = "Weekly Return")%>%
#   tab_header("Stock market this week")%>%
#   tab_source_note("Source: Yahoo")

# Weekly%>%
#   datatable(filter = "none",
#             style = "auto",
#             colnames = c("Index","Week", "Weekly Return"))%>%
#   formatPercentage(columns = "Weekly_return", digits = 2)
  
Weekly%>%
  mutate(
    Weekly_return = Weekly_return *100
  )%>%
  flextable::flextable()%>%
  set_header_labels(values = c("Price_Week" = "Week", "Weekly_return" = "Weekly Return"))%>%
  colformat_double(j=7, big.mark=",", suffix = "%", digits = 2,
  na_str = "N/A")%>%
  colformat_double(j=c(3,4,5,6), big.mark=",", digits = 0,
  na_str = "N/A")%>%
  theme_zebra()

```

### S&P 500

S&P 500 lost \~0.3%, consolidating above the 200 day moving average. Bulls so far managed to hold support and the consolidation appears like a bull flag above 200 day moving average. Technically, S&P looks like it is ready to break out in the next week or two.

```{r SPX_Monthly}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true
#| 
SPX_Monthly$Month <- factor(SPX_Monthly$Month, levels = unique(SPX_Monthly$Month))
SPX_Monthly$Year <- str_sub(SPX_Monthly$Price_Month, 1, 4)
#Monthly$Month <- str_sub(Monthly$Price_Month, 1, 2)

ggplot(SPX_Monthly%>%filter(Year >= year(Sys.Date())-5), aes(x=Year, y=Month, fill = Monthly_return))+
  geom_tile(color="black")+
  geom_text(aes(label= round(Monthly_return*100,1)))+
 # scale_fill_gradient(low="red", high="green")+
  scale_fill_gradientn(colours = hcl.colors(20, "RdYlGn"))+
  scale_y_discrete(limits=rev)+
  labs(title="Monthly return for S&P")+
    theme_custom()+
  theme(title = element_text(colour = "darkred"))+
  guides(fill=guide_legend(title="Return"))
  
  

```

### NASDAQ

Technology stocks gained \~0.6% in the week for a month to date gain of 1.7%

```{r NDX_Monthly}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true
#| 
NDX_Monthly$Month <- factor(NDX_Monthly$Month, levels = unique(NDX_Monthly$Month))
NDX_Monthly$Year <- str_sub(NDX_Monthly$Price_Month, 1, 4)
#Monthly$Month <- str_sub(Monthly$Price_Month, 1, 2)

ggplot(NDX_Monthly%>%filter(Year >= year(Sys.Date())-5), aes(x=Year, y=Month, fill = Monthly_return))+
  geom_tile(color="black")+
  geom_text(aes(label= round(Monthly_return*100,1)))+
 # scale_fill_gradient(low="red", high="green")+
  scale_fill_gradientn(colours = hcl.colors(20, "RdYlGn"))+
  scale_y_discrete(limits=rev)+
  labs(title="Monthly return for Nasdaq")+
  theme(legend.position = "none",
        title = element_text(colour = "darkred"))+
  theme_custom()+
  guides(fill=guide_legend(title="Return"))
  
  

```

### DOW Jones

DOW stayed pretty much flat with a 0.1% loss. It lost 0.8% month to date

```{r DJI_Monthly}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true
#| 
DJI_Monthly$Month <- factor(DJI_Monthly$Month, levels = unique(DJI_Monthly$Month))
DJI_Monthly$Year <- str_sub(DJI_Monthly$Price_Month, 1, 4)
#Monthly$Month <- str_sub(Monthly$Price_Month, 1, 2)

ggplot(DJI_Monthly%>%filter(Year >= year(Sys.Date())-5), aes(x=Year, y=Month, fill = Monthly_return))+
  geom_tile(color="black")+
  geom_text(aes(label= round(Monthly_return*100,1)))+
 # scale_fill_gradient(low="red", high="green")+
  scale_fill_gradientn(colours = hcl.colors(20, "RdYlGn"))+
  scale_y_discrete(limits=rev)+
  labs(title="Monthly return for DOW")+
  theme(legend.position = "none",
        title = element_text(colour = "darkred"))+
  theme_custom()+
  guides(fill=guide_legend(title="Return"))
  
  

```

### Russell

Small cap stocks gained \~1.4% for the week

```{r RUT_Monthly}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true
#| 
RUT_Monthly$Month <- factor(RUT_Monthly$Month, levels = unique(RUT_Monthly$Month))
RUT_Monthly$Year <- str_sub(RUT_Monthly$Price_Month, 1, 4)
#Monthly$Month <- str_sub(Monthly$Price_Month, 1, 2)

ggplot(RUT_Monthly%>%filter(Year >= year(Sys.Date())-5), aes(x=Year, y=Month, fill = Monthly_return))+
  geom_tile(color="black")+
  geom_text(aes(label= round(Monthly_return*100,1)))+
 # scale_fill_gradient(low="red", high="green")+
  scale_fill_gradientn(colours = hcl.colors(20, "RdYlGn"))+
  scale_y_discrete(limits=rev)+
  labs(title="Monthly return for Russell")+
  theme(legend.position = "none",
        title = element_text(colour = "darkred"))+
  theme_custom()+
  guides(fill=guide_legend(title="Return"))
  
  

```

## Bond markets

```{r Get Fred Data}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: false


Treasury_Symbols <- c("DGS3MO", "DGS6MO","DFF","DGS1", "DGS2", "DGS5","DGS7","DGS10", "DGS30")
getSymbols.FRED(Symbols = Treasury_Symbols, env = globalenv(), versbose= FALSE)

```

```{r Treasuries}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true

while (!(exists("DGS3MO", envir = parent.frame()) && exists("DGS6MO", envir = parent.frame()) && exists("DGS1", envir = parent.frame()) && exists("DGS2", envir = parent.frame()) && exists("DGS5", envir = parent.frame()) && exists("DGS7", envir = parent.frame()) && exists("DGS10", envir = parent.frame()) && exists("DGS30", envir = parent.frame()) )) {
  Sys.sleep(1)
}


Treasuries <- merge.xts(DGS3MO, DGS6MO, DGS1, DGS2, DGS5, DGS7, DGS10, DGS30)
Treasuries <- data.frame(Date = index(Treasuries), coredata(Treasuries))
colnames(Treasuries) <- c("Date","3Mos","6Mos","1Year","2Years","5Years","7Years","10Years","30Years")
rates <- c("3Mos","6Mos","1Year","2Years","5Years","7Years","10Years","30Years")
```

### Interest rates

Longer term interest rates for treasuries are trending down while shorter term rates are staying flat to slightly down for the year.

```{r Interest_Rates}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true

Treasuries%>%
  filter(year(Date)>= 2022)%>%
  pivot_longer(cols=rates)%>%
  filter(!is.na(value))%>%
ggplot(aes(x= Date))+
 geom_line(aes(y=value, group=name, color=factor(name, levels=rates)))+
  labs(x= "Date",
       y="Percentage")+
  theme_custom()+
  theme(legend.title = element_blank())


```

### Yeild Curve

Yield curve continues to slope negatively (inverted). At the higher end, it appears that it is starting to slope positively or flat but at the lower end, it still slopes significantly negative

```{r Yield_Curve}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true

Treasuries[nrow(Treasuries),]%>%
  pivot_longer(cols=rates)%>%
ggplot(aes(x=factor(name, levels=rates)))+
 geom_line(aes(y=value, group=1))+
  labs(x= "Time frame",
       y="Percentage")+
theme_custom()


```

```{r Yield_Curve_inv}
#| echo: false
#| warning: false
#| message: false
#| error: false
#| output: true

Treasuries%>%
  filter(year(Date)>= 2022)%>%
  mutate(
    `2s3mos` = `2Years` - `3Mos`,
    `10s2s` = `10Years` - `2Years` 
  )%>%
  select(Date, `2s3mos`, `10s2s`)%>%
  pivot_longer(cols=c(`2s3mos`, `10s2s`))%>%
  filter(!is.na(value))%>%
ggplot(aes(x= Date))+
 geom_line(aes(y=value, group=name, color=factor(name, levels=c("2s3mos", "10s2s"))))+
  labs(x= "Date",
       y="Percentage",
       title = "Yield curves")+
  theme_custom()+
  theme(legend.title = element_blank())
```

### Disclaimer

Anything on this blog is not an investment advice. It is essential that you fully understand the risks involved before making any investment decisions. You should consult with a financial professional to help you assess your risk tolerance and to determine an investment strategy that is suitable for your individual needs.

Please note that this disclaimer is not exhaustive and is provided for informational purposes only. Investing involves risks, and it is your responsibility to carefully consider the risks before making any investment decisions.
